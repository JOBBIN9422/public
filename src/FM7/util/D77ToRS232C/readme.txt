D77 to RS232C - RS232C経由D77イメージ書き戻しユーティリティ

by 山川機長 (http://www.ysflight.com)





はじめに

このユーティリティの使用は自己責任でお願いします。

ヤフオクでまだ割とよく動作品のFM77AVシリーズPCが出品されます。だから、動作するFM77AVを入手するのはまだ割と可能のようです。しかし、手に入れたはいいものの、陸の孤島になってしまう問題が発生します。FM77AV40EX以前であればテープインターフェース経由でデータを流し込むことができますが、FM77AV40SXではテープインターフェースもありません。

XM7が登場したとき手元のディスクをD77イメージにバックアップしたものの、今度は生フロッピーディスクに書き戻したくても書き戻す手段が無い、という問題が発生します。

テープインターフェースでデータを流し込むことは可能ですが、FM77AV用テープインターフェースケーブルがほとんど手に入りません。はんだ付けに自信があれば自作できますが、そうでないと難しいでしょう。仮にテープインターフェースケーブルを作ったとして、今度はPCから.WAVファイル経由でデータを流し込める保証がありません。手元で実験したところでは、ThinkPad 230T, 250で.WAVファイルを再生しても実機で読み込むことはできませんでした。同じ.WAVファイルを2008 MacBook Pro, Dell XPS Desktopで再生したところまったく問題なく読み込むことができました。たまたま手元のPCで読み込みに成功するかどうかはやってみるまでわかりません。

逆に、手元にレアなソフトが残っているとして、そのディスクイメージをPC上にバックアップしたいとしましょう。割とありがちだと思うのが、当時社会生活と若さと金と健康と頭髪を犠牲にして鍛えぬいたWizardryのデータをバックアップしたいとかいう需要もあるかと思います。昔はDITT.EXEを使うのが主流だったようですが、DITTを実行できるPCを見つけるのは難しくなっています。(いや、動作品のFM77AVを見つける方が簡単な気がする)。Windows XPで実行可能なNDITTもありますが、コピープロテクトでCHRNに細工のあるセクタはほとんどエラーがあると判断して読み込みません。そもそもDITTではすべての情報を読み込んでいるわけではありません。この問題を解決するために、RAWREADなるプログラムを書きましたが、(http://########)、これもなんとかして実機上に持っていかないと意味がありません。

FM77AV1, AV2、あるいはAVより前のFM-77だとRS232Cポートがデフォルトではついていなくて、もはや純正RS232Cカードの入手はほとんど不可能ですが、新たに生産できるようになりました。(http://########)

そこで、RS232Cポート経由でPCと接続してディスクイメージを実機で書き戻すユーティリティを書きました。





使い方

(1) RS232Cの接続

なにより最初にPCとFM77(あるいはディスクドライブつきのFM-7)をクロスケーブルで接続します。FM77側のRS232Cの設定ですが、FM77AV以前の機種にRS232Cカードを装着している場合はディップスイッチの5番と6番だけをオンにしてください。それ以外のディップスイッチはすべてオフです。なお、カーネギーメロン大学のコンピュータクラブの協力で純正RS232Cカードを分析したところ1〜5番のスイッチのうち二つ以上をオンにするとカードが焼ける可能性があるので、必ず1〜4をオフ、5番だけオンにしてください。6番以降は間違ってても焼けることはなさそうです。

上のリンクの互換RS232Cカードを自作したあるいはヤフオクで僕から買った場合はデフォルトでジャンパピンの5番がオンになっているはずなのでそのままにしてください。万が一輸送中に外れてしまっていた場合は、ジャンパの5番だけオンです。

このようにすると、D7CLIENT (8文字に抑えるためにD77にできなかった)は19200bpsで通信します。



(2) サーバーの起動

次に、PC上でコマンドプロンプトからサーバーを起動します。サーバーはパラメータを最低ふたつ取ります。最初のパラメータがD77イメージファイル名、二つ目がポート番号です。例えば、

    d77server.exe diskimage.d77 0

このようにすると diskimage.d77 をポート0から送信できる状態になってスタンバイ(クライアントからのリクエスト待ち)になります。なお、diskimage.d77に"####UTILDISK####"を指定するとRS232Cユーティリティディスク(Disk BASIC起動可能)を送信できます。(実行ファイルにエンベッド)

複数のディスクのD77ファイルの場合、

    d77server.exe diskimage.d77@1 0

のように指定することで2枚目、3枚目以降のディスクも送信できます。なお、@の次の数字は0が最初のディスクです。

ポート番号はシリアルポートの番号で、COM0だったら単に0と数字を指定してください。

次のようなオプションも指定できます。

-fbasic
F-BASICフォーマットのディスクと過程して未使用ドラックのセクタデータを送信しないことで早く終わらせることができます。

-noquit
デフォルトでは一枚のディスクを送信終了するとサーバーは終了しますが、同じディスクを何枚も生産したいときは-noquitオプションを指定するとサーバーが起動しっぱなしになります。

-renumfx
F?セクタをE?セクタに番号を変えて送信します。なお、コピープロテクトがF5, F6, F7セクタ等を参照している場合は実行できません。コピープロテクトがはずれているものの、セクタだけは残っているような場合だとこのオプションを使えば書き込めます。多分。

-deldupsec
DITT.EXEで作ったD77イメージの中に同じセクタが何度も書かれているものがあるようなので、ダブってるセクタを消して送信します。

-h, -help, -?
ヘルプを表示。



(3) クライアント実行

そして今度はFM77上で、

    CLEAR ,&H17FF
    LOADM "D7CLIENT",,R

でクライアントを実行します。デフォルトではドライブ1のディスクに書き込むようになっているので、ドライブ1に生ディスクあるいは消してもいいディスクを入れてキーを押すとサーバーとクライアントで通信してイメージをディスクに書き戻します。

もしもドライブ1が既に動かない(多分ドライブ0の方が酷使されてるのでそれは無いと思いますが)場合は、

    CLEAR ,&H17FF
    LOADM "D7CLIENT"
    POKE &H1802,0
    EXEC

で実行するとドライブ0に書き込みます。





鶏と卵問題

さて、クライアントをどうやってFM77に送ったもんでしょうか？クライアントさえあればなんぼでもディスクイメージを送れるからD7CLIENTが入ったディスクイメージも転送できますが、問題はクライアントが無いからディスクイメージを送信できない。

そういう場合、D77サーバーを、"####UTILDISK####"を送信するモード、-fbasicオプションで立ち上げて (例: ポートが3番だったら    d77server "####UTILDISK####" 3 -fbasic)、続いてFM77上でF-BASIC (テープモードでも可) を立ち上げて、以下のプログラムを実行してください。

100 CLEAR ,&H17FF:DEFINT A-Z:WIDTH 80,25:A=&H1800
110 OPEN "I",#1,"COM0:(F8N1)"
120 OPEN "O",#2,"COM0:(F8N1)":PRINT #2,"REQCLI":CLOSE #2
130 INPUT #1,D$:PRINT ".";
140 POKE A,VAL("&H"+D$):A=A+1
150 IF LEFT$(D$,1)<>"Q" THEN 130
160 ' POKE &H1802,0
170 EXEC &H1800

PC側から2.5KBぐらいのバイト数をF-BASICで受け取るので1分程度待つとクライアントプログラムが起動します。ドライブ1に生ディスクを入れて、リターンキーを押すとドライブ1にユーティリティディスクができます。

210行のコメントをはずすとドライブ0に書き込みますが、デフォルトだとドライブ1に書き込みます。


